<!DOCTYPE html>
<html lang="et">
<head>
	<meta charset="UTF-8">
	<title>RSS-vood</title>
	<script src="assets/main.js"></script>
	<script>includeTemplate();</script>
	<script>
const REGEX = new RegExp("item>\\s*<title>(?<name>.+?)</title>[\\s\\S]*?<link>(?:<!\\[CDATA\\[)?(?<link>.+?)(?:\\]\\]>)?<[\\s\\S]+?pubDate>(?<date>.+?)<[\\s\\S]+?(?<desc><description>[\\s\\S]+?</description>)", "g");
const REGEX2 = new RegExp("entry>[\\s\\S]+?<title>(?<name>.+?)<[\\s\\S]+?href=\"(?<link>.+?)\"[\\s\\S]+?published>(?<date>.+?)<", "g");

async function loadFeeds(sources) {
	const parser = new DOMParser();
	const proxy = "https://cors-anywhere.herokuapp.com/"

	var dataArray = [];
	for (var i = 0; i < sources.length; i++) {
		var selectedRegex = sources[i].indexOf("youtube.") == -1 ? REGEX : REGEX2;

		await fetch(proxy + sources[i])
		.then(file => file.text())
		.then(str => dataArray.push(...Array.from(str.matchAll(selectedRegex))));
	}

	dataArray.sort((a,b) => {
		let da = new Date(a.groups.date);
		let db = new Date(b.groups.date);
		return (db > da) - (db < da);
	});

	var ul = document.createElement("ul");
	var a, li, textarea, matchGroup, doc;

	for (var i = 0; i < dataArray.length && i < 55; i++) {
		matchGroup = dataArray[i].groups;

		li = document.createElement("li");
		a = document.createElement("a");
		a.className = "tooltipBox";
		a.href = matchGroup.link, "text/html";
		a.appendChild(document.createTextNode(parser.parseFromString(matchGroup.name, "text/html").documentElement.textContent));

		textarea = document.createElement("textarea");
		textarea.className = "tooltipText";
		textarea.setAttribute("readonly", "true");
		textarea.appendChild(document.createTextNode(matchGroup.date));
		if (matchGroup["desc"]){
			doc = parser.parseFromString(matchGroup.desc, "text/html");
			doc = parser.parseFromString(doc.documentElement.textContent.trim(), "text/html");
			textarea.appendChild(document.createTextNode("\n\n"+doc.documentElement.textContent));
		}

		a.appendChild(textarea);
		li.appendChild(a);
		ul.appendChild(li);
	}
	return ul;
}

window.onload = async function() {
	sources = [
	"https://www.telegram.ee/feed",
	"https://in5d.com/feed/",
	"https://www.youtube.com/feeds/videos.xml?channel_id=UCaC3wrQpIfsn4G8stxQEbDQ",
	//"https://www.youtube.com/feeds/videos.xml?channel_id=UCcYzLCs3zrQIBVHYA1sK2sw",
	"https://www.bitchute.com/feeds/rss/channel/davidicke/"
	];
	let main = document.getElementsByTagName("main")[0];
	let feedsNode = await loadFeeds(sources);
	main.innerHTML = "VÃ¤rske info allikatest <b>Telegram, In5D, Ryan Cropper, David Icke</b>";
	main.appendChild(feedsNode);

	// Load theme based on cookies
	if (getCookie("bg-color") != ""){
		changeTheme(getCookie("bg-color"));
	}

	// Add last modified date to footer
	var x = document.lastModified;
	document.getElementsByTagName("footer")[0].innerHTML += " | Loodud 28/06/2019 | Viimati muudetud " + x;
}
	</script>
	<style>
	main{padding-left:0;padding-right:0;}
	main>ul{padding:0;list-style-type:none;}
	main>ul>li{padding:5px;border:1px solid var(--main_border_color);font:11px Verdana,Geneva,sans-serif;}
	.tooltipBox{text-decoration:none;}
	.tooltipBox:link{color:var(--main_elem_color);}
	.tooltipBox:hover{text-decoration:underline;}
	.tooltipBox>.tooltipText{visibility:hidden;position:fixed;width:35%;max-width:400px;padding:3px;top:0;bottom:0;right:0;background-color:var(--main_bg_color);color:var(--main_elem_color);border-left:1px solid var(--main_border_color);box-shadow:inset 8px 0 10px -6px var(--main_border_color);opacity:0;transition:opacity .3s;text-align:center;word-wrap:break-word;overflow-x:hidden}.tooltipBox:hover>.tooltipText{visibility:visible;opacity:1}
	.spinner {
		margin: 100px auto;
		width: 50px;
		height: 40px;
		text-align: center;
		font-size: 10px;
	}
	.spinner > div {
		background-color: #333;
		height: 100%;
		width: 6px;
		display: inline-block;
		animation: sk-stretchdelay 1.2s infinite ease-in-out;
	}
	.spinner .rect2 {animation-delay: -1.1s;}
	.spinner .rect3 {animation-delay: -1.0s;}
	.spinner .rect4 {animation-delay: -0.9s;}
	.spinner .rect5 {animation-delay: -0.8s;}
	@keyframes sk-stretchdelay {0%, 40%, 100% {transform:scaleY(0.4);} 20% {transform:scaleY(1.0);}}
	</style>
</head>
<body><header></header>
<main><div class="spinner">
	<div class="rect1"></div>
	<div class="rect2"></div>
	<div class="rect3"></div>
	<div class="rect4"></div>
	<div class="rect5"></div>
</div></main>
<footer></footer></body>
</html>
